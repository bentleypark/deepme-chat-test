<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep_me WebSocket ê°ì •ëŒ€í™” í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .status {
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .connect-btn {
            background: #28a745;
            color: white;
        }
        
        .connect-btn:hover {
            background: #218838;
        }
        
        .disconnect-btn {
            background: #dc3545;
            color: white;
        }
        
        .disconnect-btn:hover {
            background: #c82333;
        }
        
        .send-btn {
            background: #007bff;
            color: white;
        }
        
        .send-btn:hover {
            background: #0056b3;
        }
        
        .clear-btn {
            background: #6c757d;
            color: white;
        }
        
        .clear-btn:hover {
            background: #545b62;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        textarea {
            min-height: 60px;
            resize: vertical;
        }

        #systemPromptInput {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .messages {
            border: 2px solid #ddd;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            word-wrap: break-word;
        }
        
        .message.sent {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        
        .message.received {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }
        
        .message.system {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        
        .message.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        
        .timestamp {
            color: #666;
            font-size: 11px;
            margin-right: 10px;
        }
        
        .response-area {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            min-height: 40px;
            font-family: 'Courier New', monospace;
        }
        
        .response-area.empty {
            background: #f5f5f5;
            border-color: #ddd;
            color: #999;
        }
        
        .session-info {
            background: #e1f5fe;
            border: 1px solid #b3e5fc;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Deep_me ê°ì •ëŒ€í™” í…ŒìŠ¤íŠ¸</h1>
        
        <div id="status" class="status disconnected">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
        
        <div class="session-info" id="sessionInfo" style="display: none;">
            <strong>ì„¸ì…˜ ID:</strong> <span id="sessionId">-</span>
        </div>
        
        <div class="controls">
            <button id="connectBtn" class="connect-btn">ì—°ê²°</button>
            <button id="disconnectBtn" class="disconnect-btn" disabled>ì—°ê²° ëŠê¸°</button>
            <button id="clearBtn" class="clear-btn">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
        
        <div class="input-group">
            <label for="userIdInput">ì‚¬ìš©ì ID (UUID):</label>
            <input type="text" id="userIdInput" value="550e8400-e29b-41d4-a716-446655440000" placeholder="UUIDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        
        <div class="input-group">
            <label for="messageInput">ë©”ì‹œì§€ (Enterë¡œ ì „ì†¡):</label>
            <textarea id="messageInput" placeholder="ì „ì†¡í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enter: ì „ì†¡, Shift+Enter: ì¤„ë°”ê¿ˆ)"></textarea>
            <button id="sendBtn" class="send-btn" disabled style="display: none;">ì „ì†¡</button>
        </div>

        <h3>ì‹¤ì‹œê°„ ì‘ë‹µ:</h3>
        <div id="responseArea" class="response-area empty">ì—¬ê¸°ì— ì‹¤ì‹œê°„ ì‘ë‹µì´ í‘œì‹œë©ë‹ˆë‹¤...</div>

        <div class="input-group">
            <label for="systemPromptInput">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì„œë²„ì—ì„œ ìë™ ë¡œë“œ):</label>
            <textarea id="systemPromptInput" placeholder="ì—°ê²° ì‹œ ì„œë²„ì—ì„œ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤..." readonly></textarea>
        </div>

        <h3>ë¡œê·¸:</h3>
        <div id="messages" class="messages"></div>
    </div>

    <script>
        let ws = null;
        let currentResponse = '';
        
        const statusEl = document.getElementById('status');
        const sessionInfoEl = document.getElementById('sessionInfo');
        const sessionIdEl = document.getElementById('sessionId');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const clearBtn = document.getElementById('clearBtn');
        const messagesEl = document.getElementById('messages');
        const responseAreaEl = document.getElementById('responseArea');
        const userIdInput = document.getElementById('userIdInput');
        const messageInput = document.getElementById('messageInput');
        const systemPromptInput = document.getElementById('systemPromptInput');
        
        function addMessage(content, type = 'system') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageEl.innerHTML = `<span class="timestamp">[${timestamp}]</span>${content}`;
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        function updateStatus(status, className) {
            statusEl.textContent = status;
            statusEl.className = `status ${className}`;
        }
        
        function updateResponse(text, isComplete = false) {
            if (isComplete) {
                responseAreaEl.className = 'response-area';
                responseAreaEl.innerHTML = `<strong>ì™„ë£Œëœ ì‘ë‹µ:</strong><br>${text}`;
            } else {
                responseAreaEl.className = 'response-area';
                responseAreaEl.innerHTML = `<strong>ì‹¤ì‹œê°„ ì‘ë‹µ:</strong><br>${text}<span style="animation: blink 1s infinite;">|</span>`;
            }
        }
        
        function clearResponse() {
            responseAreaEl.className = 'response-area empty';
            responseAreaEl.textContent = 'ì—¬ê¸°ì— ì‹¤ì‹œê°„ ì‘ë‹µì´ í‘œì‹œë©ë‹ˆë‹¤...';
        }
        
        // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function loadSystemPrompt() {
            try {
                addMessage('ğŸ”„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ì¤‘...', 'system');
                const response = await fetch('https://deep-me-v1.onrender.com/prompts/system');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.content) {
                    systemPromptInput.value = data.content;
                    addMessage('âœ… ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì™„ë£Œ', 'system');
                    addMessage(`ğŸ“‹ í”„ë¡¬í”„íŠ¸ SHA256: ${data.sha256?.substring(0, 16)}...`, 'system');
                    addMessage(`ğŸ•’ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date(data.updated_at).toLocaleString('ko-KR')}`, 'system');
                } else {
                    addMessage('âš ï¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', 'system');
                }
            } catch (error) {
                addMessage(`âŒ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        connectBtn.addEventListener('click', async () => {
            updateStatus('ì—°ê²° ì¤‘...', 'connecting');
            addMessage('WebSocket ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤... (ì›¹ í…ŒìŠ¤íŠ¸ ëª¨ë“œ)', 'system');

            // ë¨¼ì € ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤
            await loadSystemPrompt();

            try {
                // í”„ë¡œë•ì…˜ ì„œë²„ ì—°ê²° (ì›¹ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ì¸ì¦ ì—†ì´ ì—°ê²°)
                const wsUrl = `wss://deep-me-v1.onrender.com/ws/emotion`;
                addMessage(`ì—°ê²° URL: ${wsUrl}`, 'system');

                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    updateStatus('ì—°ê²°ë¨', 'connected');
                    addMessage('âœ… WebSocket ì—°ê²° ì„±ê³µ!', 'system');
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    sendBtn.disabled = false;
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        addMessage(`ìˆ˜ì‹ : ${JSON.stringify(data, null, 2)}`, 'received');
                        
                        if (data.session_id) {
                            sessionIdEl.textContent = data.session_id;
                            sessionInfoEl.style.display = 'block';
                            addMessage(`ğŸ†” ì„¸ì…˜ ID: ${data.session_id}`, 'system');

                        } else if (data.type === 'welcome') {
                            addMessage(`ğŸ‘‹ ì›°ì»´ ë©”ì‹œì§€: ${data.message}`, 'system');

                        } else if (data.type === 'message_start') {
                            // ë©”ì‹œì§€ ì‹œì‘
                            currentResponse = '';
                            clearResponse();
                            addMessage(`ğŸ“ AI ì‘ë‹µ ì‹œì‘...`, 'system');

                        } else if (data.type === 'message_delta' && data.delta) {
                            // ì‹¤ì‹œê°„ í† í° ìŠ¤íŠ¸ë¦¬ë°
                            currentResponse += data.delta;
                            updateResponse(currentResponse);

                        } else if (data.type === 'message_end') {
                            // ë©”ì‹œì§€ ì™„ë£Œ
                            updateResponse(currentResponse, true);
                            addMessage(`âœ… ì‘ë‹µ ì™„ë£Œ!`, 'system');

                        } else if (data.type === 'error') {
                            addMessage(`âŒ ì˜¤ë¥˜: ${data.message}`, 'error');

                        } else if (data.error) {
                            addMessage(`âŒ ì˜¤ë¥˜: ${data.error}`, 'error');
                            if (data.traceback) {
                                addMessage(`ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ${data.traceback}`, 'error');
                            }
                        }
                        
                    } catch (e) {
                        addMessage(`JSON íŒŒì‹± ì˜¤ë¥˜: ${e.message}`, 'error');
                        addMessage(`ì›ë³¸ ë°ì´í„°: ${event.data}`, 'error');
                    }
                };
                
                ws.onerror = (error) => {
                    addMessage(`âŒ WebSocket ì˜¤ë¥˜: ${error}`, 'error');
                };
                
                ws.onclose = (event) => {
                    updateStatus('ì—°ê²° ëŠê¹€', 'disconnected');
                    addMessage(`ğŸ”Œ ì—°ê²° ì¢…ë£Œ (ì½”ë“œ: ${event.code}, ì´ìœ : ${event.reason || 'ì—†ìŒ'})`, 'system');
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    sendBtn.disabled = true;
                    sessionInfoEl.style.display = 'none';
                    clearResponse();
                };
                
            } catch (error) {
                updateStatus('ì—°ê²° ì‹¤íŒ¨', 'disconnected');
                addMessage(`âŒ ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        });
        
        disconnectBtn.addEventListener('click', () => {
            if (ws) {
                ws.close();
                ws = null;
            }
        });
        
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('âŒ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.', 'error');
                return;
            }

            const message = messageInput.value.trim();
            if (!message) {
                addMessage('âš ï¸ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'system');
                return;
            }

            const payload = {
                user_input: message,
                step_type: 'normal'
            };

            // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ í¬í•¨
            const systemPrompt = systemPromptInput.value.trim();
            if (systemPrompt) {
                payload.system_prompt = systemPrompt;
                addMessage('ğŸ“ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ í¬í•¨í•˜ì—¬ ì „ì†¡', 'system');
            }

            addMessage(`ì†¡ì‹ : ${JSON.stringify(payload, null, 2)}`, 'sent');

            currentResponse = '';
            clearResponse();

            try {
                ws.send(JSON.stringify(payload));
                addMessage('ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ', 'system');

                // ë©”ì‹œì§€ ì „ì†¡ í›„ ì…ë ¥ í•„ë“œ í´ë¦¬ì–´
                messageInput.value = '';
                messageInput.focus(); // í¬ì»¤ìŠ¤ ìœ ì§€
            } catch (error) {
                addMessage(`âŒ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        
        clearBtn.addEventListener('click', () => {
            messagesEl.innerHTML = '';
            clearResponse();
            addMessage('ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.', 'system');
        });
        
        // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        addMessage('WebSocket í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'system');
        addMessage('1. "ì—°ê²°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'system');
        addMessage('2. ì—°ê²° í›„ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enterë¡œ ì „ì†¡í•˜ì„¸ìš”.', 'system');
        
        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes blink {
                0%, 50% { opacity: 1; }
                51%, 100% { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>